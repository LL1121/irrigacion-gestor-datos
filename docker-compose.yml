version: '3.9'

services:
  # Django Application (Irrigación Malargüe)
  irrigacion_app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: irrigacion_malargue_app
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn --config gunicorn.conf.py --bind 0.0.0.0:8000 config.wsgi:application"
    environment:
      # Django Core
      DEBUG: ${DEBUG:-False}
      SECRET_KEY: ${SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-irrigacionmalargue.net,localhost,127.0.0.1}
      
      # CSRF Protection for Cloudflare Tunnel
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-https://irrigacionmalargue.net}
      
      # Database (Shared PostgreSQL: db_central)
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@db_central:5432/${DB_NAME}
      
      # Redis Cache
      REDIS_URL: ${REDIS_URL:-redis://redis_central:6379/1}
      
      # Security (SSL handled by Cloudflare)
      SECURE_SSL_REDIRECT: "False"
      SESSION_COOKIE_SECURE: "True"
      CSRF_COOKIE_SECURE: "True"
      SECURE_HSTS_SECONDS: "31536000"
      SECURE_HSTS_INCLUDE_SUBDOMAINS: "True"
      SECURE_HSTS_PRELOAD: "True"
      
      # Optional: Sentry
      SENTRY_DSN: ${SENTRY_DSN:-}
      
    volumes:
      # Persistent media files
      - ./media:/app/media
      # Static files (served by WhiteNoise)
      - ./staticfiles:/app/staticfiles
      # Logs
      - ./logs:/var/log/malargue
      
    ports:
      # Exposed internally on 8000, mapped to 8002 for Cloudflare Tunnel
      - "8002:8000"
      
    networks:
      - shared_network
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  shared_network:
    external: true
    name: shared_network
